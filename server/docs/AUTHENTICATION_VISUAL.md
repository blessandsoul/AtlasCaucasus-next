# Tourism Server Authentication - Visual Summary

## ğŸ” System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT APPLICATION                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Memory: accessToken (15m)                                           â”‚
â”‚  LocalStorage: refreshToken (7d)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FASTIFY SERVER (PORT 3000)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MIDDLEWARE LAYER                          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  authGuard                                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Extract Bearer token from Authorization header          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Verify JWT signature (ACCESS_TOKEN_SECRET)              â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check expiration                                         â”‚   â”‚
â”‚  â”‚  â””â”€ Attach user to request.user { id, role }                â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  requireRole(role)                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check if request.user exists                            â”‚   â”‚
â”‚  â”‚  â””â”€ Verify user.role matches allowed roles                  â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  requireSelfOrAdmin                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check if user is ADMIN                                   â”‚   â”‚
â”‚  â”‚  â””â”€ OR if :id param matches user.id                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      ROUTE LAYER                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  POST /api/v1/auth/register                                  â”‚   â”‚
â”‚  â”‚  POST /api/v1/auth/login                                     â”‚   â”‚
â”‚  â”‚  POST /api/v1/auth/refresh                                   â”‚   â”‚
â”‚  â”‚  POST /api/v1/auth/logout                                    â”‚   â”‚
â”‚  â”‚  POST /api/v1/auth/logout-all    [authGuard]                â”‚   â”‚
â”‚  â”‚  GET  /api/v1/auth/me            [authGuard]                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   CONTROLLER LAYER                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  âœ… Validate input (Zod schemas)                            â”‚   â”‚
â”‚  â”‚  âœ… Extract metadata (IP, user-agent)                       â”‚   â”‚
â”‚  â”‚  âœ… Call service methods                                    â”‚   â”‚
â”‚  â”‚  âœ… Format responses (successResponse helper)               â”‚   â”‚
â”‚  â”‚  âœ… Throw typed errors                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SERVICE LAYER                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  register()                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check email exists                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ Hash password (Argon2)                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Create user                                              â”‚   â”‚
â”‚  â”‚  â””â”€ Create session + generate tokens                        â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  login()                                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ Find user by email                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ Verify password (Argon2)                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check isActive                                           â”‚   â”‚
â”‚  â”‚  â””â”€ Create session + generate tokens                        â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  refresh()                                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Verify refresh token JWT                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ Find active session                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Check tokenVersion                                       â”‚   â”‚
â”‚  â”‚  â””â”€ Generate new tokens + update session                    â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  logout()                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ Verify refresh token                                     â”‚   â”‚
â”‚  â”‚  â””â”€ Revoke session                                           â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  logoutAll()                                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ Increment tokenVersion                                   â”‚   â”‚
â”‚  â”‚  â””â”€ Revoke all user sessions                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  REPOSITORY LAYER                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  User Repo:                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ createUser()                                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ findUserByEmail()                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ findUserById()                                           â”‚   â”‚
â”‚  â”‚  â””â”€ incrementTokenVersion()                                  â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Session Repo:                                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ createSession()                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ findActiveSessionById()                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ updateSessionTokenHash()                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ revokeSession()                                          â”‚   â”‚
â”‚  â”‚  â””â”€ revokeAllUserSessions()                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MYSQL DATABASE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  users                                                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  id              UUID (PK)                                   â”‚   â”‚
â”‚  â”‚  email           VARCHAR (UNIQUE)                            â”‚   â”‚
â”‚  â”‚  passwordHash    VARCHAR (Argon2)                            â”‚   â”‚
â”‚  â”‚  firstName       VARCHAR                                     â”‚   â”‚
â”‚  â”‚  lastName        VARCHAR                                     â”‚   â”‚
â”‚  â”‚  role            ENUM(USER, COMPANY, ADMIN)                  â”‚   â”‚
â”‚  â”‚  isActive        BOOLEAN                                     â”‚   â”‚
â”‚  â”‚  tokenVersion    INT (for global token revocation)           â”‚   â”‚
â”‚  â”‚  createdAt       TIMESTAMP                                   â”‚   â”‚
â”‚  â”‚  updatedAt       TIMESTAMP                                   â”‚   â”‚
â”‚  â”‚  deletedAt       TIMESTAMP (nullable)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  user_sessions                                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  id                  UUID (PK)                               â”‚   â”‚
â”‚  â”‚  userId              UUID (FK â†’ users.id)                    â”‚   â”‚
â”‚  â”‚  refreshTokenHash    VARCHAR (SHA-256)                       â”‚   â”‚
â”‚  â”‚  expiresAt           TIMESTAMP                               â”‚   â”‚
â”‚  â”‚  revokedAt           TIMESTAMP (nullable)                    â”‚   â”‚
â”‚  â”‚  lastUsedAt          TIMESTAMP                               â”‚   â”‚
â”‚  â”‚  userAgent           VARCHAR (nullable)                      â”‚   â”‚
â”‚  â”‚  ipAddress           VARCHAR (nullable)                      â”‚   â”‚
â”‚  â”‚  createdAt           TIMESTAMP                               â”‚   â”‚
â”‚  â”‚  updatedAt           TIMESTAMP                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Authentication Flow Diagrams

### Registration Flow

```
Client                    Server                     Database
  â”‚                         â”‚                            â”‚
  â”œâ”€ POST /auth/register â”€â”€â–ºâ”‚                            â”‚
  â”‚  {email, password,      â”‚                            â”‚
  â”‚   firstName, lastName}  â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Validate input           â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Check email exists â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (not found)               â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Hash password (Argon2)   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Create user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (user created)            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Generate access token    â”‚
  â”‚                         â”‚  (JWT, 15m expiry)         â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Generate temp refresh    â”‚
  â”‚                         â”‚  token (random 32 bytes)   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Hash refresh token       â”‚
  â”‚                         â”‚  (SHA-256)                 â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Create session â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (session created)         â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Generate final refresh   â”‚
  â”‚                         â”‚  token (JWT with          â”‚
  â”‚                         â”‚  sessionId, 7d expiry)     â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Update session hash â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚â—„â”€ 201 Created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  {user, accessToken,    â”‚                            â”‚
  â”‚   refreshToken}         â”‚                            â”‚
  â”‚                         â”‚                            â”‚
```

### Login Flow

```
Client                    Server                     Database
  â”‚                         â”‚                            â”‚
  â”œâ”€ POST /auth/login â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
  â”‚  {email, password}      â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Validate input           â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Find user by email â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (user found)              â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Check isActive           â”‚
  â”‚                         â”‚  (must be true)            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Verify password          â”‚
  â”‚                         â”‚  (Argon2.verify)           â”‚
  â”‚                         â”‚  âœ… Match                  â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Create session +         â”‚
  â”‚                         â”‚  generate tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  {user, accessToken,    â”‚                            â”‚
  â”‚   refreshToken}         â”‚                            â”‚
  â”‚                         â”‚                            â”‚
```

### Token Refresh Flow

```
Client                    Server                     Database
  â”‚                         â”‚                            â”‚
  â”œâ”€ POST /auth/refresh â”€â”€â”€â–ºâ”‚                            â”‚
  â”‚  {refreshToken}         â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Verify JWT               â”‚
  â”‚                         â”‚  (REFRESH_TOKEN_SECRET)    â”‚
  â”‚                         â”‚  âœ… Valid                  â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Extract payload:         â”‚
  â”‚                         â”‚  {userId, sessionId,       â”‚
  â”‚                         â”‚   tokenVersion}            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Find active session â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (session found)           â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Find user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (user found)              â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Check tokenVersion       â”‚
  â”‚                         â”‚  (must match)              â”‚
  â”‚                         â”‚  âœ… Match                  â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Generate new access      â”‚
  â”‚                         â”‚  token (15m)               â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Generate new refresh     â”‚
  â”‚                         â”‚  token (7d)                â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Update session hash â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                            â”‚
  â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  {accessToken,          â”‚                            â”‚
  â”‚   refreshToken}         â”‚                            â”‚
  â”‚                         â”‚                            â”‚
```

### Protected Request Flow

```
Client                    Server                     Database
  â”‚                         â”‚                            â”‚
  â”œâ”€ GET /api/v1/me â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
  â”‚  Authorization: Bearer  â”‚                            â”‚
  â”‚  <accessToken>          â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ authGuard middleware     â”‚
  â”‚                         â”‚  â”œâ”€ Extract Bearer token  â”‚
  â”‚                         â”‚  â”œâ”€ Verify JWT            â”‚
  â”‚                         â”‚  â”‚  (ACCESS_TOKEN_SECRET) â”‚
  â”‚                         â”‚  â”œâ”€ Check expiration      â”‚
  â”‚                         â”‚  â””â”€ Attach user to        â”‚
  â”‚                         â”‚     request.user          â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Controller handler       â”‚
  â”‚                         â”‚  â”œâ”€ Access request.user   â”‚
  â”‚                         â”‚  â””â”€ Call service          â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Find user by ID â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (user data)               â”‚
  â”‚                         â”‚                            â”‚
  â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  {user: {...}}          â”‚                            â”‚
  â”‚                         â”‚                            â”‚
```

### Logout All Sessions Flow

```
Client                    Server                     Database
  â”‚                         â”‚                            â”‚
  â”œâ”€ POST /auth/logout-all â–ºâ”‚                            â”‚
  â”‚  Authorization: Bearer  â”‚                            â”‚
  â”‚  <accessToken>          â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ authGuard middleware     â”‚
  â”‚                         â”‚  (verifies access token)   â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Increment tokenVersion â”€â”€â–ºâ”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (version: 0 â†’ 1)          â”‚
  â”‚                         â”‚                            â”‚
  â”‚                         â”œâ”€ Revoke all sessions â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚  (set revokedAt)           â”‚
  â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚  (3 sessions revoked)      â”‚
  â”‚                         â”‚                            â”‚
  â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚  {revokedCount: 3}      â”‚                            â”‚
  â”‚                         â”‚                            â”‚
  â”‚  All refresh tokens     â”‚                            â”‚
  â”‚  now invalid (version   â”‚                            â”‚
  â”‚  mismatch)              â”‚                            â”‚
  â”‚                         â”‚                            â”‚
```

---

## ğŸ”‘ Token Anatomy

### Access Token (JWT)

```
Header:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payload:
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "role": "USER",
  "iat": 1735506000,
  "exp": 1735506900
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  ACCESS_TOKEN_SECRET
)

Result:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJ1c2VySWQiOiI1NTBlODQwMC1lMjliLTQxZDQtYTcxNi00NDY2NTU0NDAwMDAiLCJyb2xlIjoiVVNFUiIsImlhdCI6MTczNTUwNjAwMCwiZXhwIjoxNzM1NTA2OTAwfQ.
signature-here
```

### Refresh Token (JWT)

```
Header:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payload:
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "sessionId": "660e8400-e29b-41d4-a716-446655440001",
  "tokenVersion": 0,
  "iat": 1735506000,
  "exp": 1736110800
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  REFRESH_TOKEN_SECRET
)
```

---

## ğŸ¯ Role-Based Access Control

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ENDPOINTS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  PUBLIC (No Auth)                                            â”‚
â”‚  â”œâ”€ POST /auth/register                                      â”‚
â”‚  â”œâ”€ POST /auth/login                                         â”‚
â”‚  â”œâ”€ POST /auth/refresh                                       â”‚
â”‚  â””â”€ POST /auth/logout                                        â”‚
â”‚                                                               â”‚
â”‚  AUTHENTICATED (Any Role)                                    â”‚
â”‚  â”œâ”€ GET  /auth/me                                            â”‚
â”‚  â”œâ”€ POST /auth/logout-all                                    â”‚
â”‚  â”œâ”€ GET  /me/tours                                           â”‚
â”‚  â””â”€ POST /tours                                              â”‚
â”‚                                                               â”‚
â”‚  ADMIN ONLY                                                  â”‚
â”‚  â”œâ”€ GET  /users (list all)                                   â”‚
â”‚  â”œâ”€ POST /users (create with role)                           â”‚
â”‚  â””â”€ PATCH /users/:id/role                                    â”‚
â”‚                                                               â”‚
â”‚  SELF OR ADMIN                                               â”‚
â”‚  â”œâ”€ GET    /users/:id                                        â”‚
â”‚  â”œâ”€ PATCH  /users/:id                                        â”‚
â”‚  â””â”€ DELETE /users/:id                                        â”‚
â”‚                                                               â”‚
â”‚  COMPANY OR ADMIN                                            â”‚
â”‚  â”œâ”€ POST /hotels                                             â”‚
â”‚  â”œâ”€ POST /restaurants                                        â”‚
â”‚  â””â”€ GET  /bookings                                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Last Updated:** 2025-12-29
